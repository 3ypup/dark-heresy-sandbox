<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Dark Heresy AR GM</title>
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #05060a;
      color: #f5f5f5;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 260px;
      border-right: 1px solid #222;
      padding: 12px;
      box-sizing: border-box;
      background: #0b0c12;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
      min-width: 0;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    h2 {
      margin: 10px 0 4px;
      font-size: 15px;
    }
    h3 {
      margin: 6px 0 4px;
      font-size: 13px;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }
    input, select, button, textarea {
      font-family: inherit;
      font-size: 13px;
    }
    input, select, textarea {
      background: #151720;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px 6px;
      color: #f5f5f5;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 48px;
    }
    button {
      background: #1c4a8a;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      color: #f5f5f5;
      cursor: pointer;
      font-weight: 500;
    }
    button.secondary {
      background: #333;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .campaign-list {
      flex: 1;
      border: 1px solid #222;
      border-radius: 4px;
      overflow-y: auto;
      background: #080910;
    }
    .campaign-item {
      padding: 6px 8px;
      border-bottom: 1px solid #111;
      cursor: pointer;
      font-size: 13px;
    }
    .campaign-item:hover {
      background: #151720;
    }
    .campaign-item.active {
      background: #1c4a8a;
    }
    .row {
      display: flex;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }
    .col {
      flex: 1;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 8px;
      box-sizing: border-box;
      background: #080910;
      overflow-y: auto;
      min-width: 0;
    }
    .scene-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }
    .scene-title {
      font-size: 16px;
      font-weight: 600;
    }
    .scene-type {
      font-size: 11px;
      color: #aaa;
    }
    .scene-body {
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .ascii-map {
      font-family: "Fira Code", "Consolas", monospace;
      background: #05060a;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #333;
      white-space: pre;
      font-size: 11px;
      margin-top: 4px;
    }
    .location-block {
      font-size: 12px;
      margin-top: 6px;
    }
    .location-name {
      font-weight: 600;
    }
    .gm-notes {
      font-size: 12px;
      color: #ddd;
      background: #0b0d16;
      padding: 6px;
      border-radius: 4px;
      border: 1px dashed #444;
      margin-top: 6px;
    }
    .gm-notes-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #888;
      margin-bottom: 4px;
    }
    .dialogue-block {
      font-size: 13px;
      background: #0c0f18;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #222;
      margin-top: 6px;
    }
    .dialogue-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #999;
      margin-bottom: 4px;
    }
    .dialogue-line {
      margin-bottom: 2px;
    }
    .dialogue-line span.speaker {
      color: #f0c674;
      font-weight: 600;
    }
    .encounter-block {
      font-size: 12px;
      margin-top: 6px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #222;
      background: #05060f;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .choice-btn {
      text-align: left;
      width: 100%;
    }
    .choice-hint {
      font-size: 11px;
      color: #bbb;
      margin-top: 2px;
    }
    .badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 10px;
      background: #333;
      margin-left: 4px;
    }
    .log-list {
      font-size: 12px;
      max-height: 240px;
      overflow-y: auto;
      border: 1px solid #222;
      border-radius: 4px;
      padding: 4px 6px;
      background: #05060c;
    }
    .log-item {
      border-bottom: 1px solid #111;
      padding: 3px 0;
    }
    .log-date {
      color: #777;
      font-size: 10px;
    }
    .log-type {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 4px;
      background: #333;
      font-size: 10px;
      margin-right: 4px;
    }
    .campaign-meta {
      font-size: 12px;
      color: #ddd;
    }
    .campaign-meta-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .campaign-premise {
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .intro-snippet {
      margin-top: 4px;
      font-size: 12px;
      white-space: pre-wrap;
      color: #bbb;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>Dark Heresy GM</h1>

    <div>
      <h2>Новое приключение</h2>
      <label>Игроков</label>
      <input type="number" id="numPlayers" min="2" max="6" value="4" />
      <label>Средний опыт (exp)</label>
      <input type="number" id="avgExp" min="0" max="10000" value="400" />
      <label>Мир / сектор (опционально)</label>
      <input type="text" id="world" placeholder="Скintila, субсектор Каликсиса..." />
      <button id="btnGenerate">Создать приключение</button>
    </div>

    <div>
      <h2>Приключения</h2>
      <div id="campaignList" class="campaign-list"></div>
    </div>
  </div>

  <div class="main">
    <div class="campaign-meta">
      <div class="campaign-meta-title" id="campaignTitle">Выберите или создайте приключение</div>
      <div id="campaignWorld"></div>
      <div class="campaign-premise" id="campaignPremise"></div>
      <div class="intro-snippet" id="campaignIntro"></div>
    </div>

    <div class="row">
      <div class="col" id="sceneCol">
        <div class="scene-header">
          <div class="scene-title" id="sceneTitle">Нет активной сцены</div>
          <div class="scene-type" id="sceneType"></div>
        </div>

        <div class="scene-body" id="scenePlayerText"></div>

        <div id="sceneDialogues" class="dialogue-block" style="display:none;">
          <div class="dialogue-title">Примерные реплики</div>
          <div id="dialogueLines"></div>
        </div>

        <div id="sceneGMNotes" class="gm-notes" style="display:none;">
          <div class="gm-notes-title">Заметки мастера</div>
          <div id="gmNotesBody"></div>
        </div>

        <div class="location-block">
          <div class="location-name" id="locationName"></div>
          <div id="locationDesc"></div>
          <div id="asciiMap" class="ascii-map" style="display:none;"></div>
        </div>

        <div id="sceneEncounter" class="encounter-block" style="display:none;"></div>

        <div class="choices" id="sceneChoices"></div>
      </div>

      <div class="col" id="rightCol">
        <h2>Журнал</h2>
        <div id="logList" class="log-list"></div>

        <h2>Проверка</h2>
        <div style="font-size: 12px; margin-bottom: 4px;">
          Здесь мы просто фиксируем результаты бросков. Игроки кидают кости на столе.
        </div>
        <label>Название проверки</label>
        <input id="checkName" placeholder="Запугивание культиста" />
        <label>Навык / характеристика</label>
        <input id="checkSkill" placeholder="Запугивание, Воля, Внимание..." />
        <label>Сложность (текст)</label>
        <input id="checkDifficulty" placeholder="+10, -20 и т.п." />
        <label>Результат</label>
        <select id="checkSuccess">
          <option value="true">Успех</option>
          <option value="false">Провал</option>
        </select>
        <label>Степени успеха/провала (опционально)</label>
        <input id="checkDegrees" type="number" />
        <label>Примечание</label>
        <textarea id="checkNotes" placeholder="Культист бежит, бросая оружие..."></textarea>
        <button id="btnSaveCheck">Сохранить проверку</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = window.location.origin;

    async function api(path, options = {}) {
      const res = await fetch(apiBase + path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      if (!res.ok) {
        let text;
        try { text = await res.text(); } catch { text = res.statusText; }
        throw new Error(text || res.statusText || "Request failed");
      }
      return res.json();
    }

    let campaigns = [];
    let currentCampaignId = null;
    let scenesById = new Map();

    async function loadCampaigns() {
      campaigns = await api("/campaigns");
      renderCampaignList();
    }

    function renderCampaignList() {
      const cont = document.getElementById("campaignList");
      cont.innerHTML = "";
      campaigns.forEach(c => {
        const div = document.createElement("div");
        div.className = "campaign-item" + (c.id === currentCampaignId ? " active" : "");
        div.textContent = `#${c.id} ${c.title}`;
        div.onclick = () => selectCampaign(c.id);
        cont.appendChild(div);
      });
    }

    async function selectCampaign(id) {
      currentCampaignId = id;
      renderCampaignList();
      const full = await api(`/campaigns/${id}`);
      const state = await api(`/campaigns/${id}/state`);
      const logs = await api(`/campaigns/${id}/logs`);

      scenesById = new Map();
      full.scenes.forEach(s => scenesById.set(s.id, s));

      renderCampaignMeta(full);
      renderScene(full, state.current_scene);
      renderLogs(logs);
    }

    function renderCampaignMeta(campaign) {
      document.getElementById("campaignTitle").textContent = campaign.title;
      document.getElementById("campaignWorld").textContent = campaign.world
        ? `Мир/сектор: ${campaign.world}`
        : "Мир/сектор: не указан";
      document.getElementById("campaignPremise").textContent = campaign.premise || "";
      document.getElementById("campaignIntro").textContent = campaign.intro_text || "";
    }

    function renderScene(campaign, scene) {
      const titleEl = document.getElementById("sceneTitle");
      const typeEl = document.getElementById("sceneType");
      const pTextEl = document.getElementById("scenePlayerText");
      const dlgBlock = document.getElementById("sceneDialogues");
      const dlgLines = document.getElementById("dialogueLines");
      const gmBlock = document.getElementById("sceneGMNotes");
      const gmBody = document.getElementById("gmNotesBody");
      const locNameEl = document.getElementById("locationName");
      const locDescEl = document.getElementById("locationDesc");
      const asciiEl = document.getElementById("asciiMap");
      const encBlock = document.getElementById("sceneEncounter");
      const choicesEl = document.getElementById("sceneChoices");

      if (!scene) {
        titleEl.textContent = "Нет активной сцены";
        typeEl.textContent = "";
        pTextEl.textContent = "";
        dlgBlock.style.display = "none";
        gmBlock.style.display = "none";
        locNameEl.textContent = "";
        locDescEl.textContent = "";
        asciiEl.style.display = "none";
        encBlock.style.display = "none";
        choicesEl.innerHTML = "";
        return;
      }

      titleEl.textContent = scene.name;
      typeEl.textContent = `Сцена: ${scene.scene_type}`;
      pTextEl.textContent = scene.player_text || "";

      // Диалоги
      dlgLines.innerHTML = "";
      if (scene.dialogues_json) {
        try {
          const arr = JSON.parse(scene.dialogues_json);
          if (Array.isArray(arr) && arr.length) {
            dlgBlock.style.display = "block";
            arr.forEach(line => {
              const div = document.createElement("div");
              div.className = "dialogue-line";
              const speaker = document.createElement("span");
              speaker.className = "speaker";
              speaker.textContent = (line.speaker || "Кто-то") + ": ";
              const text = document.createElement("span");
              text.textContent = line.text || "";
              div.appendChild(speaker);
              div.appendChild(text);
              dlgLines.appendChild(div);
            });
          } else {
            dlgBlock.style.display = "none";
          }
        } catch {
          dlgBlock.style.display = "none";
        }
      } else {
        dlgBlock.style.display = "none";
      }

      // Заметки мастеру
      if (scene.gm_notes) {
        gmBlock.style.display = "block";
        gmBody.textContent = scene.gm_notes;
      } else {
        gmBlock.style.display = "none";
      }

      // Локация
      const loc = campaign.locations.find(l => l.id === scene.location_id);
      if (loc) {
        locNameEl.textContent = loc.name;
        locDescEl.textContent = loc.description || "";
        if (loc.ascii_map) {
          asciiEl.style.display = "block";
          asciiEl.textContent = loc.ascii_map;
        } else {
          asciiEl.style.display = "none";
        }
      } else {
        locNameEl.textContent = "";
        locDescEl.textContent = "";
        asciiEl.style.display = "none";
      }

      // Энкаунтер
      if (scene.encounter) {
        const e = scene.encounter;
        let html = "";
        if (e.objectives) {
          html += `<div><b>Цель сцены:</b> ${e.objectives}</div>`;
        }
        if (e.npc_summary) {
          html += `<div><b>Противники / участники:</b> ${e.npc_summary}</div>`;
        }
        if (e.victory_text || e.defeat_text || e.escape_text) {
          html += `<div style="margin-top:4px;"><b>Варианты исхода:</b></div>`;
          if (e.victory_text) html += `<div>Победа: ${e.victory_text}</div>`;
          if (e.defeat_text) html += `<div>Провал: ${e.defeat_text}</div>`;
          if (e.escape_text) html += `<div>Бегство: ${e.escape_text}</div>`;
        }
        encBlock.innerHTML = html;
        encBlock.style.display = html ? "block" : "none";
      } else {
        encBlock.style.display = "none";
      }

      // Выборы → кнопки (страница за страницей)
      choicesEl.innerHTML = "";
      if (scene.choices && scene.choices.length) {
        scene.choices.forEach(ch => {
          const wrapper = document.createElement("div");
          const btn = document.createElement("button");
          btn.className = "choice-btn";
          btn.textContent = ch.label;
          btn.onclick = () => makeChoice(ch.id);
          wrapper.appendChild(btn);
          if (ch.result_hint || ch.description) {
            const hint = document.createElement("div");
            hint.className = "choice-hint";
            hint.textContent = ch.result_hint || ch.description;
            wrapper.appendChild(hint);
          }
          choicesEl.appendChild(wrapper);
        });
      } else {
        const span = document.createElement("div");
        span.style.fontSize = "12px";
        span.style.color = "#999";
        span.textContent = "Выборов больше нет. Если это финальная сцена, опишите исход игрокам и завершите приключение.";
        choicesEl.appendChild(span);
      }
    }

    function renderLogs(logs) {
      const cont = document.getElementById("logList");
      cont.innerHTML = "";
      logs.forEach(l => {
        const div = document.createElement("div");
        div.className = "log-item";
        const d = new Date(l.created_at);
        const date = document.createElement("div");
        date.className = "log-date";
        date.textContent = d.toLocaleString();
        const content = document.createElement("div");
        const typeSpan = document.createElement("span");
        typeSpan.className = "log-type";
        typeSpan.textContent = l.entry_type;
        content.appendChild(typeSpan);
        const textNode = document.createTextNode(" " + l.content);
        content.appendChild(textNode);
        div.appendChild(date);
        div.appendChild(content);
        cont.appendChild(div);
      });
      cont.scrollTop = cont.scrollHeight;
    }

    async function makeChoice(choiceId) {
      if (!currentCampaignId) return;
      try {
        const state = await api(`/campaigns/${currentCampaignId}/choose`, {
          method: "POST",
          body: JSON.stringify({ choice_id: choiceId }),
        });
        const full = await api(`/campaigns/${currentCampaignId}`);
        const logs = await api(`/campaigns/${currentCampaignId}/logs`);
        scenesById = new Map();
        full.scenes.forEach(s => scenesById.set(s.id, s));
        renderCampaignMeta(full);
        renderScene(full, state.current_scene);
        renderLogs(logs);
      } catch (e) {
        alert("Ошибка при выборе: " + e.message);
      }
    }

    async function saveCheck() {
      if (!currentCampaignId) {
        alert("Сначала выберите приключение");
        return;
      }
      const name = document.getElementById("checkName").value || "Безымянная проверка";
      const skill = document.getElementById("checkSkill").value || "";
      const difficulty = document.getElementById("checkDifficulty").value || "";
      const success = document.getElementById("checkSuccess").value === "true";
      const degreesRaw = document.getElementById("checkDegrees").value;
      const degrees = degreesRaw === "" ? null : Number(degreesRaw);
      const notes = document.getElementById("checkNotes").value || "";

      try {
        await api(`/campaigns/${currentCampaignId}/checks`, {
          method: "POST",
          body: JSON.stringify({ name, skill, difficulty, success, degrees, notes }),
        });
        const logs = await api(`/campaigns/${currentCampaignId}/logs`);
        renderLogs(logs);
        document.getElementById("checkName").value = "";
        document.getElementById("checkSkill").value = "";
        document.getElementById("checkDifficulty").value = "";
        document.getElementById("checkDegrees").value = "";
        document.getElementById("checkNotes").value = "";
      } catch (e) {
        alert("Ошибка при сохранении проверки: " + e.message);
      }
    }

    async function generateAdventure() {
      const btn = document.getElementById("btnGenerate");
      btn.disabled = true;
      btn.textContent = "Генерация...";
      try {
        const numPlayers = Number(document.getElementById("numPlayers").value || "4");
        const avgExp = Number(document.getElementById("avgExp").value || "400");
        const world = document.getElementById("world").value || null;

        const res = await api("/adventures/autogenerate", {
          method: "POST",
          body: JSON.stringify({ num_players: numPlayers, avg_exp: avgExp, world }),
        });

        await loadCampaigns();
        currentCampaignId = res.campaign.id;
        await selectCampaign(res.campaign.id);
      } catch (e) {
        alert("Ошибка при генерации приключения: " + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Создать приключение";
      }
    }

    document.getElementById("btnGenerate").onclick = generateAdventure;
    document.getElementById("btnSaveCheck").onclick = saveCheck;

    loadCampaigns().catch(console.error);
  </script>
</body>
</html>
