<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Dark Heresy AR GM</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #05060a;
      color: #f5f5f5;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 260px;
      border-right: 1px solid #222;
      padding: 12px;
      box-sizing: border-box;
      background: #0b0c12;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    h2 {
      margin: 12px 0 4px;
      font-size: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 2px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    input, select, button, textarea {
      font-family: inherit;
      font-size: 13px;
    }
    input, select, textarea {
      background: #151720;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px 6px;
      color: #f5f5f5;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 48px;
    }
    button {
      background: #1c4a8a;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      color: #f5f5f5;
      cursor: pointer;
    }
    button.secondary {
      background: #333;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .campaign-list {
      flex: 1;
      border: 1px solid #222;
      border-radius: 4px;
      overflow-y: auto;
      background: #080910;
    }
    .campaign-item {
      padding: 6px 8px;
      border-bottom: 1px solid #111;
      cursor: pointer;
      font-size: 13px;
    }
    .campaign-item:hover {
      background: #151720;
    }
    .campaign-item.active {
      background: #1c4a8a;
    }
    .row {
      display: flex;
      gap: 12px;
    }
    .col {
      flex: 1;
      border: 1px solid #222;
      border-radius: 4px;
      padding: 8px;
      box-sizing: border-box;
      background: #080910;
      overflow-y: auto;
    }
    .ascii-map {
      font-family: "Fira Code", "Consolas", monospace;
      background: #05060a;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #333;
      white-space: pre;
      font-size: 11px;
    }
    .gm-notes {
      font-size: 12px;
      color: #aaa;
      background: #0b0d16;
      padding: 6px;
      border-radius: 4px;
      border: 1px dashed #444;
    }
    .dialogue-block {
      font-size: 13px;
      background: #0c0f18;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #222;
    }
    .dialogue-line span.speaker {
      color: #f0c674;
      font-weight: 600;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .choice-btn {
      text-align: left;
      width: 100%;
    }
    .log-list {
      font-size: 12px;
      max-height: 220px;
      overflow-y: auto;
    }
    .log-item {
      border-bottom: 1px solid #111;
      padding: 4px 0;
    }
    .log-date {
      color: #777;
      font-size: 11px;
    }
    .badge {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 4px;
      background: #333;
      font-size: 10px;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>Dark Heresy GM</h1>
    <div>
      <h2>Новое приключение</h2>
      <label>Игроков</label>
      <input type="number" id="numPlayers" min="2" max="6" value="4" />
      <label>Средний опыт (exp)</label>
      <input type="number" id="avgExp" min="0" max="10000" value="400" />
      <label>Мир / сектор (опционально)</label>
      <input type="text" id="world" placeholder="Скintila, Субсектор Каликсиса..." />
      <button id="btnGenerate">Создать приключение</button>
    </div>

    <div>
      <h2>Кампании</h2>
      <div id="campaignList" class="campaign-list"></div>
    </div>
  </div>

  <div class="main">
    <div class="row" style="flex: 1; min-height: 0;">
      <div class="col" id="campaignInfo">
        <h2>Кампания</h2>
        <div id="campaignMeta"></div>
        <h3>Вступление</h3>
        <div id="campaignIntro" style="font-size: 13px; white-space: pre-wrap;"></div>
      </div>

      <div class="col" id="sceneInfo">
        <h2>Текущая сцена</h2>
        <div id="sceneTitle"></div>
        <div id="sceneType" style="font-size: 11px; color: #888; margin-bottom: 4px;"></div>
        <div id="scenePlayerText" style="font-size: 13px; white-space: pre-wrap; margin-bottom: 6px;"></div>

        <div id="sceneDialogues" class="dialogue-block" style="display:none; margin-bottom: 6px;"></div>

        <div id="sceneGMNotes" class="gm-notes" style="display:none; margin-bottom: 6px;"></div>

        <div>
          <h3 style="font-size: 13px; margin: 6px 0 2px;">Локация</h3>
          <div id="locationName" style="font-size: 13px; font-weight: 600;"></div>
          <div id="locationDesc" style="font-size: 12px; white-space: pre-wrap; margin-bottom: 4px;"></div>
          <div id="asciiMap" class="ascii-map" style="display:none;"></div>
        </div>

        <div id="sceneEncounter" style="font-size: 12px; margin-top: 6px;"></div>

        <div style="margin-top: 8px;">
          <h3 style="font-size: 13px; margin: 6px 0 2px;">Варианты действий</h3>
          <div id="sceneChoices" class="choices"></div>
        </div>
      </div>

      <div class="col">
        <h2>Журнал</h2>
        <div id="logList" class="log-list"></div>

        <h2>Проверка</h2>
        <div style="font-size: 12px; margin-bottom: 4px;">Минимум проверок на ПК. Просто фиксируем результат.</div>
        <label>Название проверки</label>
        <input id="checkName" placeholder="Запугивание культиста" />
        <label>Навык / характеристика</label>
        <input id="checkSkill" placeholder="Запугивание, Воля" />
        <label>Сложность (текст)</label>
        <input id="checkDifficulty" placeholder="+10, -20 и т.п." />
        <label>Результат</label>
        <select id="checkSuccess">
          <option value="true">Успех</option>
          <option value="false">Провал</option>
        </select>
        <label>Степени успеха/провала (опционально)</label>
        <input id="checkDegrees" type="number" />
        <label>Примечание</label>
        <textarea id="checkNotes" placeholder="Культист бежит, бросая оружие..."></textarea>
        <button id="btnSaveCheck">Сохранить проверку</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = window.location.origin;

    async function api(path, options = {}) {
      const res = await fetch(apiBase + path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      if (!res.ok) {
        let text;
        try { text = await res.text(); } catch { text = res.statusText; }
        throw new Error(text || res.statusText || "Request failed");
      }
      return res.json();
    }

    let campaigns = [];
    let currentCampaignId = null;
    let campaignScenesById = new Map();

    async function loadCampaigns() {
      campaigns = await api("/campaigns");
      renderCampaignList();
    }

    function renderCampaignList() {
      const cont = document.getElementById("campaignList");
      cont.innerHTML = "";
      campaigns.forEach(c => {
        const div = document.createElement("div");
        div.className = "campaign-item" + (c.id === currentCampaignId ? " active" : "");
        div.textContent = `#${c.id} ${c.title}`;
        div.onclick = () => selectCampaign(c.id);
        cont.appendChild(div);
      });
    }

    async function selectCampaign(id) {
      currentCampaignId = id;
      renderCampaignList();
      const full = await api(`/campaigns/${id}`);
      const state = await api(`/campaigns/${id}/state`);
      const logs = await api(`/campaigns/${id}/logs`);

      // индексируем сцены по id
      campaignScenesById = new Map();
      full.scenes.forEach(s => campaignScenesById.set(s.id, s));

      renderCampaign(full, state, logs);
    }

    function renderCampaign(campaign, state, logs) {
      // мета
      const metaEl = document.getElementById("campaignMeta");
      metaEl.innerHTML = `
        <div><b>${campaign.title}</b></div>
        <div style="font-size: 12px; color:#aaa;">Мир: ${campaign.world || "не указан"}</div>
        <div style="font-size: 12px; margin-top:4px;">${campaign.premise || ""}</div>
      `;

      document.getElementById("campaignIntro").textContent = campaign.intro_text || "";

      // сцена
      let scene = state.current_scene;
      if (!scene && state.current_scene_id && campaignScenesById.has(state.current_scene_id)) {
        scene = campaignScenesById.get(state.current_scene_id);
      }

      renderScene(campaign, scene);
      renderLogs(logs);
    }

    function renderScene(campaign, scene) {
      const titleEl = document.getElementById("sceneTitle");
      const typeEl = document.getElementById("sceneType");
      const pTextEl = document.getElementById("scenePlayerText");
      const dlgEl = document.getElementById("sceneDialogues");
      const gmEl = document.getElementById("sceneGMNotes");
      const locNameEl = document.getElementById("locationName");
      const locDescEl = document.getElementById("locationDesc");
      const asciiEl = document.getElementById("asciiMap");
      const encEl = document.getElementById("sceneEncounter");
      const choicesEl = document.getElementById("sceneChoices");

      if (!scene) {
        titleEl.textContent = "Нет активной сцены";
        typeEl.textContent = "";
        pTextEl.textContent = "";
        dlgEl.style.display = "none";
        gmEl.style.display = "none";
        locNameEl.textContent = "";
        locDescEl.textContent = "";
        asciiEl.style.display = "none";
        encEl.textContent = "";
        choicesEl.innerHTML = "";
        return;
      }

      titleEl.textContent = scene.name;
      typeEl.textContent = `Тип: ${scene.scene_type}`;
      pTextEl.textContent = scene.player_text || "";

      // диалоги
      if (scene.dialogues_json) {
        try {
          const arr = JSON.parse(scene.dialogues_json);
          if (Array.isArray(arr) && arr.length) {
            dlgEl.style.display = "block";
            dlgEl.innerHTML = "<div style='font-weight:600;margin-bottom:4px;'>Примерные реплики</div>";
            arr.forEach(line => {
              const div = document.createElement("div");
              div.className = "dialogue-line";
              const speaker = document.createElement("span");
              speaker.className = "speaker";
              speaker.textContent = (line.speaker || "Кто-то") + ": ";
              const text = document.createElement("span");
              text.textContent = line.text || "";
              div.appendChild(speaker);
              div.appendChild(text);
              dlgEl.appendChild(div);
            });
          } else {
            dlgEl.style.display = "none";
          }
        } catch {
          dlgEl.style.display = "none";
        }
      } else {
        dlgEl.style.display = "none";
      }

      // заметки мастеру
      if (scene.gm_notes) {
        gmEl.style.display = "block";
        gmEl.textContent = scene.gm_notes;
      } else {
        gmEl.style.display = "none";
      }

      // локация
      const loc = campaign.locations.find(l => l.id === scene.location_id);
      if (loc) {
        locNameEl.textContent = loc.name;
        locDescEl.textContent = loc.description || "";
        if (loc.ascii_map) {
          asciiEl.style.display = "block";
          asciiEl.textContent = loc.ascii_map;
        } else {
          asciiEl.style.display = "none";
        }
      } else {
        locNameEl.textContent = "";
        locDescEl.textContent = "";
        asciiEl.style.display = "none";
      }

      // encounter
      if (scene.encounter) {
        const e = scene.encounter;
        encEl.innerHTML = "";
        if (e.objectives) {
          encEl.innerHTML += `<div><b>Цель:</b> ${e.objectives}</div>`;
        }
        if (e.npc_summary) {
          encEl.innerHTML += `<div><b>Силы противника:</b> ${e.npc_summary}</div>`;
        }
        if (e.victory_text || e.defeat_text || e.escape_text) {
          encEl.innerHTML += `<div style="margin-top:4px;"><b>Исходы:</b></div>`;
          if (e.victory_text) encEl.innerHTML += `<div>Победа: ${e.victory_text}</div>`;
          if (e.defeat_text) encEl.innerHTML += `<div>Поражение: ${e.defeat_text}</div>`;
          if (e.escape_text) encEl.innerHTML += `<div>Бегство: ${e.escape_text}</div>`;
        }
      } else {
        encEl.textContent = "";
      }

      // выборы
      choicesEl.innerHTML = "";
      if (scene.choices && scene.choices.length) {
        scene.choices.forEach(ch => {
          const btn = document.createElement("button");
          btn.className = "choice-btn";
          btn.textContent = ch.label;
          btn.onclick = () => makeChoice(ch.id);
          btn.title = ch.result_hint || ch.description || "";
          choicesEl.appendChild(btn);
        });
      } else {
        const span = document.createElement("div");
        span.style.fontSize = "12px";
        span.style.color = "#777";
        span.textContent = "Выборов нет — можно перейти к следующей сцене по своему усмотрению.";
        choicesEl.appendChild(span);
      }
    }

    function renderLogs(logs) {
      const cont = document.getElementById("logList");
      cont.innerHTML = "";
      logs.forEach(l => {
        const div = document.createElement("div");
        div.className = "log-item";
        const d = new Date(l.created_at);
        const date = document.createElement("div");
        date.className = "log-date";
        date.textContent = d.toLocaleString();
        const content = document.createElement("div");
        content.innerHTML = `<span class="badge">${l.entry_type}</span>${l.content}`;
        div.appendChild(date);
        div.appendChild(content);
        cont.appendChild(div);
      });
      cont.scrollTop = cont.scrollHeight;
    }

    async function makeChoice(choiceId) {
      if (!currentCampaignId) return;
      try {
        const state = await api(`/campaigns/${currentCampaignId}/choose`, {
          method: "POST",
          body: JSON.stringify({ choice_id: choiceId }),
        });
        const full = await api(`/campaigns/${currentCampaignId}`);
        const logs = await api(`/campaigns/${currentCampaignId}/logs`);
        // обновим индекс сцен
        campaignScenesById = new Map();
        full.scenes.forEach(s => campaignScenesById.set(s.id, s));
        renderCampaign(full, state, logs);
      } catch (e) {
        alert("Ошибка при выборе: " + e.message);
      }
    }

    async function saveCheck() {
      if (!currentCampaignId) {
        alert("Сначала выбери кампанию");
        return;
      }
      const name = document.getElementById("checkName").value || "Безымянная проверка";
      const skill = document.getElementById("checkSkill").value || "";
      const difficulty = document.getElementById("checkDifficulty").value || "";
      const success = document.getElementById("checkSuccess").value === "true";
      const degreesRaw = document.getElementById("checkDegrees").value;
      const degrees = degreesRaw === "" ? null : Number(degreesRaw);
      const notes = document.getElementById("checkNotes").value || "";

      try {
        await api(`/campaigns/${currentCampaignId}/checks`, {
          method: "POST",
          body: JSON.stringify({ name, skill, difficulty, success, degrees, notes }),
        });
        const logs = await api(`/campaigns/${currentCampaignId}/logs`);
        renderLogs(logs);
        document.getElementById("checkName").value = "";
        document.getElementById("checkSkill").value = "";
        document.getElementById("checkDifficulty").value = "";
        document.getElementById("checkDegrees").value = "";
        document.getElementById("checkNotes").value = "";
      } catch (e) {
        alert("Ошибка при сохранении проверки: " + e.message);
      }
    }

    async function generateAdventure() {
      const btn = document.getElementById("btnGenerate");
      btn.disabled = true;
      btn.textContent = "Генерация...";
      try {
        const numPlayers = Number(document.getElementById("numPlayers").value || "4");
        const avgExp = Number(document.getElementById("avgExp").value || "400");
        const world = document.getElementById("world").value || null;

        const res = await api("/adventures/autogenerate", {
          method: "POST",
          body: JSON.stringify({ num_players: numPlayers, avg_exp: avgExp, world }),
        });

        await loadCampaigns();
        currentCampaignId = res.campaign.id;
        await selectCampaign(res.campaign.id);
      } catch (e) {
        alert("Ошибка при генерации приключения: " + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Создать приключение";
      }
    }

    document.getElementById("btnGenerate").onclick = generateAdventure;
    document.getElementById("btnSaveCheck").onclick = saveCheck;

    loadCampaigns().catch(console.error);
  </script>
</body>
</html>
